<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>IRMAO AR - Versión Estable</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    
    <!-- Orden CRÍTICO de scripts -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <!-- Versión UMD compatible (sin módulos ES6) -->
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.1/dist/mindar-image-umd.min.js"></script>
    
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
            touch-action: none;
        }
        #ar-container {
            position: fixed;
            width: 100%;
            height: 100%;
        }
        #status {
            position: fixed;
            top: 20px;
            left: 20px;
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 10px 20px;
            border-radius: 20px;
            z-index: 1000;
            font-family: Arial, sans-serif;
        }
        #start-button {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 30px;
            z-index: 1000;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div id="status">Preparando experiencia AR...</div>
    <button id="start-button" disabled>INICIAR AR</button>
    
    <div id="ar-container">
        <a-scene 
            mindar-image="imageTargetSrc: assets/targets.mind; autoStart: false;"
            embedded
            vr-mode-ui="enabled: false"
            renderer="precision: mediump; antialias: true;"
        >
            <a-assets>
                <audio id="sound" src="assets/plane-fx.mp3" preload="auto"></audio>
            </a-assets>

            <a-camera 
                position="0 0 0" 
                look-controls="enabled: false"
                wasd-controls="enabled: false"
            ></a-camera>

            <a-entity mindar-image-target="targetIndex: 0">
                <a-image
                    src="assets/irmao-plane.png"
                    position="0 0.5 0"
                    width="1.5"
                    height="0.7"
                    animation="property: position; to: 0 0.8 0.5; dur: 3000; loop: true"
                ></a-image>
                <a-sound src="#sound" autoplay="false" loop="true"></a-sound>
            </a-entity>
        </a-scene>
    </div>

    <script>
        // Verificar compatibilidad
        function checkCompatibility() {
            const features = {
                'WebGL': () => {
                    try {
                        const canvas = document.createElement('canvas');
                        return !!window.WebGLRenderingContext && 
                               (canvas.getContext('webgl') || canvas.getContext('experimental-webgl'));
                    } catch(e) {
                        return false;
                    }
                },
                'MediaDevices': () => !!navigator.mediaDevices,
                'getUserMedia': () => !!navigator.mediaDevices.getUserMedia
            };
            
            const missing = Object.keys(features).filter(f => !features[f]());
            
            if (missing.length > 0) {
                document.getElementById('status').innerHTML = 
                    `Tu dispositivo no soporta:<br>${missing.join(', ')}<br><br>
                    Prueba con:<br>- Chrome/Firefox actualizado<br>- Otro dispositivo`;
                return false;
            }
            return true;
        }

        // Inicialización segura
        document.addEventListener('DOMContentLoaded', () => {
            const scene = document.querySelector('a-scene');
            const statusEl = document.getElementById('status');
            const startButton = document.getElementById('start-button');
            
            if (!checkCompatibility()) return;
            
            // Esperar a que A-Frame cargue completamente
            scene.addEventListener('loaded', () => {
                statusEl.textContent = "Presiona INICIAR AR";
                startButton.disabled = false;
                
                startButton.addEventListener('click', async () => {
                    statusEl.textContent = "Iniciando cámara...";
                    startButton.disabled = true;
                    
                    try {
                        // 1. Verificar permisos de cámara primero
                        const stream = await navigator.mediaDevices.getUserMedia({ 
                            video: { 
                                facingMode: 'environment',
                                width: { ideal: 1280 },
                                height: { ideal: 720 }
                            } 
                        });
                        stream.getTracks().forEach(track => track.stop());
                        
                        // 2. Iniciar MindAR después de obtener permisos
                        await scene.system.start();
                        
                        // 3. Reproducir sonido
                        document.querySelector('#sound').components.sound.playSound();
                        
                        statusEl.textContent = "Apunta a tu etiqueta IRMAO";
                    } catch (error) {
                        console.error("Error AR:", error);
                        startButton.disabled = false;
                        
                        if (error.name === 'NotAllowedError') {
                            statusEl.textContent = "Permiso de cámara denegado. Recarga y permite el acceso.";
                        } else if (error.name === 'NotFoundError') {
                            statusEl.textContent = "No se encontró cámara compatible";
                        } else {
                            statusEl.textContent = `Error: ${error.message}`;
                        }
                    }
                });
            });
        });
    </script>
</body>
</html>
