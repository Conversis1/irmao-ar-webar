<!DOCTYPE html>
<html>
  <head>
    <title>IRMAO AR Streaming</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- A-Frame & MindAR -->
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.1.4/dist/mindar-image-aframe.prod.js"></script>
    <!-- HLS.js -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
      body {
        margin: 0;
        overflow: hidden;
      }
      #start-button {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 1em 2em;
        font-size: 1.2em;
        background-color: #000;
        color: #fff;
        border: none;
        border-radius: 8px;
        z-index: 10;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <!-- Start Button -->
    <button id="start-button">Iniciar experiencia</button>

    <!-- Hidden Video Element -->
    <video
      id="video"
      playsinline
      muted
      crossorigin="anonymous"
      webkit-playsinline
      style="display: none"
    ></video>

    <!-- Plane Sound -->
    <audio id="plane-sound" src="assets/plane-fx.mp3" preload="auto"></audio>

    <!-- AR Scene -->
    <div id="container" style="width: 100vw; height: 100vh; display: none;">
      <a-scene
        mindar-image="imageTargetSrc: assets/irmaoetiqueta1.mind;"
        embedded
        color-space="sRGB"
        renderer="colorManagement: true; physicallyCorrectLights"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: true"
      >
        <a-assets>
          <img id="plane-img" src="assets/irmao-plane.png" />
        </a-assets>

        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <a-entity mindar-image-target="targetIndex: 0">
          <!-- Streaming Video -->
          <a-video
            id="video-plane"
            width="1.5"
            height="0.9"
            position="0 0 0"
            rotation="0 0 0"
          ></a-video>

          <!-- Animated Plane -->
          <a-image
            id="plane"
            src="#plane-img"
            position="-1 0.3 0"
            scale="0.6 0.3 1"
            rotation="0 0 0"
            visible="false"
          >
            <!-- Rotating Animation (propeller mimic) -->
            <a-animation
              attribute="rotation"
              to="0 360 0"
              dur="1500"
              repeat="indefinite"
              easing="linear"
            ></a-animation>

            <!-- Flight Animation -->
            <a-animation
              id="plane-fly"
              attribute="position"
              from="-1 0.3 0"
              to="1 0.3 0"
              dur="6000"
              easing="linear"
              begin="startPlane"
            ></a-animation>
          </a-image>
        </a-entity>
      </a-scene>
    </div>

    <!-- Script Logic -->
    <script>
      const startButton = document.getElementById("start-button");
      const container = document.getElementById("container");
      const video = document.getElementById("video");
      const planeSound = document.getElementById("plane-sound");
      const plane = document.getElementById("plane");
      const videoPlane = document.querySelector("#video-plane");

      let mindarStarted = false;

      startButton.addEventListener("click", () => {
        startButton.style.display = "none";
        container.style.display = "block";

        // Load and play HLS video robustly
        if (Hls.isSupported()) {
          const hls = new Hls();
          hls.loadSource("assets/irmaoStream.m3u8");
          hls.attachMedia(video);

          hls.on(Hls.Events.MANIFEST_PARSED, () => {
            video
              .play()
              .catch((err) =>
                console.warn("Video play prevented:", err)
              );
          });
        } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
          video.src = "assets/irmaoStream.m3u8";
          video.addEventListener("loadedmetadata", () => {
            video
              .play()
              .catch((err) =>
                console.warn("Video play prevented:", err)
              );
          });
        } else {
          console.error("HLS not supported on this browser");
        }

        // Wait for video to be ready to use as texture
        video.addEventListener("canplay", () => {
          console.log("Video can play, attaching as texture");
          videoPlane.setAttribute("src", "#video");
        });

        // Start plane animation and sound on AR target found
        const sceneEl = document.querySelector("a-scene");

        sceneEl.addEventListener("targetFound", () => {
          if (!mindarStarted) {
            mindarStarted = true;
            console.log("Target found! Starting plane animation and sound.");
            plane.setAttribute("visible", "true");
            plane.emit("startPlane");
            planeSound.play().catch((e) =>
